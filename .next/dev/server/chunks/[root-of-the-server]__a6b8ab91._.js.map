{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///F:/Proyectos/dniAPI/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst connectionString = process.env.DATABASE_URL;\n\nif (!connectionString) {\n  throw new Error('DATABASE_URL is missing');\n}\n\nexport const pool = new Pool({\n  connectionString,\n  ssl: { rejectUnauthorized: false },\n});\n\nexport async function query(text: string, params?: any[]) {\n  const start = Date.now();\n  const res = await pool.query(text, params);\n  const duration = Date.now() - start;\n  // console.log('executed query', { text, duration, rows: res.rowCount });\n  return res;\n}\n"],"names":[],"mappings":";;;;;;AAAA;;;;;;AAEA,MAAM,mBAAmB,QAAQ,GAAG,CAAC,YAAY;AAEjD,IAAI,CAAC,kBAAkB;IACrB,MAAM,IAAI,MAAM;AAClB;AAEO,MAAM,OAAO,IAAI,4GAAI,CAAC;IAC3B;IACA,KAAK;QAAE,oBAAoB;IAAM;AACnC;AAEO,eAAe,MAAM,IAAY,EAAE,MAAc;IACtD,MAAM,QAAQ,KAAK,GAAG;IACtB,MAAM,MAAM,MAAM,KAAK,KAAK,CAAC,MAAM;IACnC,MAAM,WAAW,KAAK,GAAG,KAAK;IAC9B,yEAAyE;IACzE,OAAO;AACT"}},
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///F:/Proyectos/dniAPI/app/api/settings/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { pool } from '@/lib/db';\nimport { cookies } from 'next/headers';\nimport jwt from 'jsonwebtoken';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'secret';\n\nasync function getUser(request: Request) {\n  const cookieStore = await cookies();\n  const cookieAuth = cookieStore.get('auth_token');\n  if (cookieAuth) {\n    try {\n      const decoded: any = jwt.verify(cookieAuth.value, JWT_SECRET);\n      return decoded.user; // user_id (email or whatever was used)\n    } catch (e) {}\n  }\n  return null;\n}\n\nexport async function GET(request: Request) {\n  const user = await getUser(request);\n  if (!user) return NextResponse.json({ success: false, message: 'Unauthorized' }, { status: 401 });\n\n  try {\n    const res = await pool.query('SELECT * FROM user_settings WHERE user_id = $1', [user]);\n    if (res.rows.length > 0) {\n        return NextResponse.json({ success: true, settings: res.rows[0] });\n    }\n    return NextResponse.json({ success: true, settings: {} });\n  } catch (error: any) {\n    return NextResponse.json({ success: false, error: error.message }, { status: 500 });\n  }\n}\n\nexport async function POST(request: Request) {\n  const user = await getUser(request);\n  if (!user) return NextResponse.json({ success: false, message: 'Unauthorized' }, { status: 401 });\n\n  try {\n    const body = await request.json();\n    const { factiliza_token, dniperu_token, dniperu_security, dniperu_cc_token, dniperu_cc_sig } = body;\n\n    await pool.query(\n        `INSERT INTO user_settings (user_id, factiliza_token, dniperu_token, dniperu_security, dniperu_cc_token, dniperu_cc_sig, updated_at)\n         VALUES ($1, $2, $3, $4, $5, $6, NOW())\n         ON CONFLICT (user_id) \n         DO UPDATE SET \n            factiliza_token = $2, \n            dniperu_token = $3, \n            dniperu_security = $4, \n            dniperu_cc_token = $5, \n            dniperu_cc_sig = $6,\n            updated_at = NOW()`,\n        [user, factiliza_token, dniperu_token, dniperu_security, dniperu_cc_token, dniperu_cc_sig]\n    );\n\n    return NextResponse.json({ success: true, message: 'Settings saved' });\n  } catch (error: any) {\n    return NextResponse.json({ success: false, error: error.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;;;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAE7C,eAAe,QAAQ,OAAgB;IACrC,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,aAAa,YAAY,GAAG,CAAC;IACnC,IAAI,YAAY;QACd,IAAI;YACF,MAAM,UAAe,kJAAG,CAAC,MAAM,CAAC,WAAW,KAAK,EAAE;YAClD,OAAO,QAAQ,IAAI,EAAE,uCAAuC;QAC9D,EAAE,OAAO,GAAG,CAAC;IACf;IACA,OAAO;AACT;AAEO,eAAe,IAAI,OAAgB;IACxC,MAAM,OAAO,MAAM,QAAQ;IAC3B,IAAI,CAAC,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,SAAS;QAAO,SAAS;IAAe,GAAG;QAAE,QAAQ;IAAI;IAE/F,IAAI;QACF,MAAM,MAAM,MAAM,mHAAI,CAAC,KAAK,CAAC,kDAAkD;YAAC;SAAK;QACrF,IAAI,IAAI,IAAI,CAAC,MAAM,GAAG,GAAG;YACrB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAM,UAAU,IAAI,IAAI,CAAC,EAAE;YAAC;QACpE;QACA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,UAAU,CAAC;QAAE;IACzD,EAAE,OAAO,OAAY;QACnB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnF;AACF;AAEO,eAAe,KAAK,OAAgB;IACzC,MAAM,OAAO,MAAM,QAAQ;IAC3B,IAAI,CAAC,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,SAAS;QAAO,SAAS;IAAe,GAAG;QAAE,QAAQ;IAAI;IAE/F,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,eAAe,EAAE,aAAa,EAAE,gBAAgB,EAAE,gBAAgB,EAAE,cAAc,EAAE,GAAG;QAE/F,MAAM,mHAAI,CAAC,KAAK,CACZ,CAAC;;;;;;;;;8BASqB,CAAC,EACvB;YAAC;YAAM;YAAiB;YAAe;YAAkB;YAAkB;SAAe;QAG9F,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,SAAS;QAAiB;IACtE,EAAE,OAAO,OAAY;QACnB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnF;AACF"}}]
}